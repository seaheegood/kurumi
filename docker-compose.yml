# ==============================================
# Kurumi Docker Compose 설정
# ==============================================
# 사용법:
#   시작: docker compose up -d
#   중지: docker compose down
#   로그: docker compose logs -f
#   재시작: docker compose restart
# ==============================================

services:
  app:
    # 컨테이너 이름
    container_name: kurumi-app

    # 현재 디렉토리의 Dockerfile로 이미지 빌드
    build:
      context: .
      dockerfile: Dockerfile

    # 또는 이미 빌드된 이미지 사용 시:
    # image: kurumi:latest

    # 포트 매핑 (호스트:컨테이너)
    ports:
      - "8080:8080"

    # 환경 변수 (.env 파일에서 로드)
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-3600000}
      - TZ=Asia/Seoul

    # 환경 변수 파일 (민감한 정보는 여기에)
    env_file:
      - .env

    # 볼륨 마운트
    volumes:
      # 업로드 폴더 (컨테이너 재시작해도 데이터 유지)
      - ./uploads:/app/uploads

    # 재시작 정책
    restart: unless-stopped

    # 헬스 체크
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/menus"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ==============================================
# .env 파일 예시 (.env.example 참조)
# ==============================================
# SPRING_DATASOURCE_URL=jdbc:mysql://your-db-host:3306/kurumi
# SPRING_DATASOURCE_USERNAME=your_username
# SPRING_DATASOURCE_PASSWORD=your_password
# JWT_SECRET=your_jwt_secret_key_minimum_64_characters
# JWT_EXPIRATION=3600000
# ==============================================
